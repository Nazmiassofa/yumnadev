import discord
import asyncio
import re
from discord.ext import commands

class Immune(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        self.immune_users = {}  # Menyimpan waktu imun per user
        self.MAX_IMMUNE_DURATION = 86400  # Batas maksimal waktu immune: 24 jam (86400 detik)

    @commands.command(name="immune")
    async def immune(self, ctx, duration: str):
        """Memberikan imun terhadap auto-disconnect selama durasi tertentu."""
        time_map = {"s": 1, "m": 60, "h": 3600}
        match = re.match(r"^(\d+)([smh])$", duration)

        if not match:
            embed = discord.Embed(
                title="⚠️ Format Tidak Valid!",
                description="Gunakan format yang benar seperti:\n`!immune 1h`, `!immune 30m`, atau `!immune 10s`.",
                color=discord.Color.orange()
            )
            await ctx.send(embed=embed)
            return

        value, unit = int(match.group(1)), match.group(2)
        immune_duration = value * time_map[unit]

        # Cek batas maksimal waktu immune
        if immune_duration > self.MAX_IMMUNE_DURATION:
            embed = discord.Embed(
                title="⚠️ Durasi Terlalu Lama!",
                description=f"Durasi maksimal immune adalah **24 jam**.",
                color=discord.Color.orange()
            )
            await ctx.send(embed=embed)
            return

        # Tambahkan user ke daftar immune
        self.immune_users[ctx.author.id] = asyncio.get_event_loop().time() + immune_duration
        
        embed = discord.Embed(
            title="✅ Imun Diberikan!",
            description=f"**{ctx.author.mention}** tidak bisa di-disconnect selama **{value} {unit}**.",
            color=discord.Color.green()
        )
        await ctx.send(embed=embed)

        # Hapus imun setelah waktu habis
        await asyncio.sleep(immune_duration)
        if ctx.author.id in self.immune_users:
            self.immune_users.pop(ctx.author.id)

    @commands.command(name="cancelimmune")
    async def cancel_immune(self, ctx):
        """Membatalkan imun yang sedang aktif."""
        if ctx.author.id in self.immune_users:
            self.immune_users.pop(ctx.author.id)
            embed = discord.Embed(
                title="✅ Imun Dibatalkan!",
                description=f"**{ctx.author.mention}** tidak lagi memiliki imun.",
                color=discord.Color.green()
            )
        else:
            embed = discord.Embed(
                title="⚠️ Tidak Ada Imun Aktif!",
                description=f"**{ctx.author.mention}** tidak memiliki imun yang aktif.",
                color=discord.Color.orange()
            )
        await ctx.send(embed=embed)
        
    async def is_immune(self, member: discord.Member):
        """Cek apakah member masih memiliki imun aktif."""
        return self.immune_users.get(member.id, 0) > asyncio.get_event_loop().time()

async def setup(bot):
    await bot.add_cog(Immune(bot))